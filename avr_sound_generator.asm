.DEVICE atmega328p

.dseg
abFSIdx: .Byte 12 ; frequency sample indices, each element points to a sample of a specific frequency

.cseg
.org 0

.def YL = r28
.def YH = r29
.def ZL = r30
.def ZH = r31

.def nNULL	= r16
.def ZLsave	= r17
.def ZHsave	= r18
.def nSmpIx	= r19
.def nSmpVe	= r20
.def nBits	= r21
.def mOut	= r22
.def rTest	= r23

setup:

; define PORTD as output

		ldi		r16,	0xff
		out		DDRD,	r16
		out		PORTD,	r16

init:

; initialize a register with NULL for later use

		eor		nNULL,	nNULL			; we need a NULL in a register :-(

; initialize all Frequency-Sample-Indices with "0"

		ldi	 	YL,		low (abFSIdx)	; index of sample in wave
		ldi	 	YH,		high(abFSIdx)
		st		Y,		nNULL			; 0 => anPosFrequencies[ 0]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 1]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 2]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 3]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 4]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 5]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 6]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 7]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 8]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[ 9]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[10]
		adiw	YL,		1
		st		Y,		nNULL			; 0 => anPosFrequencies[11]

loop:

; sample index into the wave to Y

		ldi	 	YL,		low (abFSIdx*2)	; index of sample in wave
		ldi	 	YH,		high(abFSIdx*2)	;   -- " --
		ld		nSmpIx,	Y				; anPosFrequencies[0] => r17

; start pointer of the wave to Z

		ldi		ZL,		low (abWaveC*2)	; address of the wave matrix to Z
		ldi		ZH,		high(abWaveC*2)	;   -- " --
		mov		ZLsave,	ZL				; sometimes we need the startpoint again later on
		mov		ZHsave,	ZH				;   -- " --

; add index of the next sample to wave pointer

		add		ZL,		nSmpIx			; &abWaveSet[abFSIdx[0]]  (X)
		adc		ZH,		nNULL			;   -- " --
		add		ZL,		nSmpIx			;   -- " --
		adc		ZH,		nNULL			;   -- " --

; get and check the next sample

strt1:
		lpm								; load [Z] to r0
		tst		r0						; set the flag
		brne	next1					; if not 0, we are done with reading

; end of wave, restart the wave

		mov		ZL,		ZLsave			; reset Z to start of vector to restart the wave
		mov		ZH,		ZHsave			;   -- " --
		mov		nSmpIx,	nNULL			; the sample pointer becomes 0 too
		rjmp	strt1					; now get the correct value

; output sample value

next1:
		inc		nSmpIx					; next time the next sample
		st		Y,		nSmpIx			; write back to abFSIdx


; D to A converter [ geprueft! ]

; level / 32
		mov		nBits, 	r0				; the sample value
		lsr		nBits
		lsr		nBits
		lsr		nBits
		lsr		nBits
		lsr		nBits

dac:
; cummulate bits
		eor		mOut,	mOut			; initialize output byte

		inc		nBits					; prepair nBits
for:	dec		nBits					; loop for bits to set
		breq	end						; break if no bits to set anymore

		lsl		mOut					; shift existing bits
		ori		mOut,	0x04			; insert bit 2
		rjmp	for						; loop to-for

end:                  					; output result
		out		PORTD,	mOut			; 

		nop

		jmp		loop


abWaveSet:
;==================================================================================================================================================================================================
abWaveC:
.db 128,132,136,140,144,148,152,156,161,165,169,172,176,180,184,188,191,195,198,202,205,208,212,215,218,221,223,226,229,231,233,236,238,240,242,243,245,247,248,249,250,251,252,253,254,254,254,254
.db 254,254,254,254,253,253,252,251,250,249,247,246,244,243,241,239,237,235,232,230,227,225,222,219,216,213,210,207,203,200,197,193,189,186,182,178,174,171,167,163,159,154,150,146,142,138,134,130
.db 125,121,117,113,109,105,101, 96, 92, 88, 84, 81, 77, 73, 69, 66, 62, 58, 55, 52, 48, 45, 42, 39, 36, 33, 30, 28, 25, 23, 20, 18, 16, 14, 12, 11,  9,  8,  6,  5,  4,  3,  2,  2,  1,  1,  1,  1
.db   1,  1,  1,  1,  2,  3,  4,  5,  6,  7,  8, 10, 12, 13, 15, 17, 19, 22, 24, 26, 29, 32, 34, 37, 40, 43, 47, 50, 53, 57, 60, 64, 67, 71, 75, 79, 83, 86, 90, 94, 99,103,107,111,115,119,123,  0
;==================================================================================================================================================================================================
abWaveCIS:
.db 128,132,136,141,145,150,154,158,163,167,171,175,179,183,187,191,195,199,202,206,209,212,216,219,222,225,228,230,233,235,237,240,242,244,245,247,248,250,251,252,253,253,254,254,254,254,254,254
.db 254,253,253,252,251,250,248,247,245,244,242,240,237,235,233,230,228,225,222,219,216,212,209,206,202,199,195,191,187,183,179,175,171,167,163,158,154,150,145,141,136,132,128,123,119,114,110,105
.db 101, 97, 92, 88, 84, 80, 76, 72, 68, 64, 60, 56, 53, 49, 46, 43, 39, 36, 33, 30, 27, 25, 22, 20, 18, 15, 13, 11, 10,  8,  7,  5,  4,  3,  2,  2,  1,  1,  1,  1,  1,  1,  1,  2,  2,  3,  4,  5
.db   7,  8, 10, 11, 13, 15, 18, 20, 22, 25, 27, 30, 33, 36, 39, 43, 46, 49, 53, 56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 97,101,105,110,114,119,123,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveD:
.db 128,132,137,142,146,151,155,160,165,169,173,178,182,186,190,194,198,202,206,210,213,216,220,223,226,229,232,234,237,239,241,243,245,247,248,250,251,252,253,253,254,254,254,254,254,254,253,253
.db 252,251,250,248,247,245,243,241,239,237,234,232,229,226,223,220,216,213,210,206,202,198,194,190,186,182,178,173,169,165,160,155,151,146,142,137,132,128,123,118,113,109,104,100, 95, 90, 86, 82
.db  77, 73, 69, 65, 61, 57, 53, 49, 45, 42, 39, 35, 32, 29, 26, 23, 21, 18, 16, 14, 12, 10,  8,  7,  5,  4,  3,  2,  2,  1,  1,  1,  1,  1,  1,  2,  2,  3,  4,  5,  7,  8, 10, 12, 14, 16, 18, 21
.db  23, 26, 29, 32, 35, 39, 42, 45, 49, 53, 57, 61, 65, 69, 73, 77, 82, 86, 90, 95,100,104,109,113,118,123,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveDIS:
.db 128,132,137,142,147,152,157,162,167,171,176,181,185,190,194,198,202,206,210,214,217,221,224,227,230,233,236,238,241,243,245,247,248,250,251,252,253,254,254,254,254,254,254,254,253,252,251,250
.db 248,247,245,243,241,238,236,233,230,227,224,221,217,214,210,206,202,198,194,190,185,181,176,171,167,162,157,152,147,142,137,132,128,123,118,113,108,103, 98, 93, 88, 84, 79, 74, 70, 65, 61, 57
.db  53, 49, 45, 41, 38, 34, 31, 28, 25, 22, 19, 17, 14, 12, 10,  8,  7,  5,  4,  3,  2,  1,  1,  1,  1,  1,  1,  1,  2,  3,  4,  5,  7,  8, 10, 12, 14, 17, 19, 22, 25, 28, 31, 34, 38, 41, 45, 49
.db  53, 57, 61, 65, 70, 74, 79, 84, 88, 93, 98,103,108,113,118,123,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveE:
.db 128,133,138,143,149,154,159,164,169,174,179,184,188,193,197,202,206,210,214,218,221,225,228,231,234,237,240,242,244,246,248,250,251,252,253,254,254,254,254,254,254,253,253,251,250,249,247,245
.db 243,241,238,236,233,230,227,223,220,216,212,208,204,200,195,191,186,181,176,171,166,161,156,151,146,141,135,130,125,120,114,109,104, 99, 94, 89, 84, 79, 74, 69, 64, 60, 55, 51, 47, 43, 39, 35
.db  32, 28, 25, 22, 19, 17, 14, 12, 10,  8,  6,  5,  4,  2,  2,  1,  1,  1,  1,  1,  1,  2,  3,  4,  5,  7,  9, 11, 13, 15, 18, 21, 24, 27, 30, 34, 37, 41, 45, 49, 53, 58, 62, 67, 71, 76, 81, 86
.db  91, 96,101,106,112,117,122,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveF:
.db 128,133,139,144,150,155,161,166,171,176,182,187,191,196,201,205,210,214,218,222,225,229,232,235,238,241,243,245,247,249,250,252,253,254,254,254,254,254,254,253,252,251,250,248,246,244,242,239
.db 237,234,230,227,223,220,216,212,207,203,198,194,189,184,179,174,169,163,158,152,147,141,136,130,125,119,114,108,103, 97, 92, 86, 81, 76, 71, 66, 61, 57, 52, 48, 43, 39, 35, 32, 28, 25, 21, 18
.db  16, 13, 11,  9,  7,  5,  4,  3,  2,  1,  1,  1,  1,  1,  1,  2,  3,  5,  6,  8, 10, 12, 14, 17, 20, 23, 26, 30, 33, 37, 41, 45, 50, 54, 59, 64, 68, 73, 79, 84, 89, 94,100,105,111,116,122,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveFIS:
.db 128,133,139,145,151,157,163,168,174,179,184,190,195,200,205,209,214,218,222,226,229,233,236,239,242,244,246,248,250,251,253,253,254,254,254,254,254,253,252,251,249,247,245,243,240,237,234,231
.db 228,224,220,216,211,207,202,197,192,187,182,176,171,165,160,154,148,142,136,130,125,119,113,107,101, 95, 90, 84, 79, 73, 68, 63, 58, 53, 48, 44, 39, 35, 31, 27, 24, 21, 18, 15, 12, 10,  8,  6
.db   4,  3,  2,  1,  1,  1,  1,  1,  2,  2,  4,  5,  7,  9, 11, 13, 16, 19, 22, 26, 29, 33, 37, 41, 46, 50, 55, 60, 65, 71, 76, 81, 87, 92, 98,104,110,116,122,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveG:
.db 128,134,140,146,152,159,165,171,176,182,188,193,199,204,209,213,218,222,226,230,234,237,240,243,245,247,249,251,252,253,254,254,254,254,254,253,252,250,248,246,244,241,239,235,232,228,224,220
.db 216,211,206,201,196,191,185,179,174,168,162,156,149,143,137,131,124,118,112,106, 99, 93, 87, 81, 76, 70, 64, 59, 54, 49, 44, 39, 35, 31, 27, 23, 20, 16, 14, 11,  9,  7,  5,  3,  2,  1,  1,  1
.db   1,  1,  2,  3,  4,  6,  8, 10, 12, 15, 18, 21, 25, 29, 33, 37, 42, 46, 51, 56, 62, 67, 73, 79, 84, 90, 96,103,109,115,121,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveGIS:
.db 128,134,141,147,154,160,167,173,179,185,191,197,202,207,212,217,222,226,230,234,237,241,244,246,248,250,252,253,254,254,254,254,254,253,252,250,248,246,244,241,237,234,230,226,222,217,212,207
.db 202,197,191,185,179,173,167,160,154,147,141,134,128,121,114,108,101, 95, 88, 82, 76, 70, 64, 58, 53, 48, 43, 38, 33, 29, 25, 21, 18, 14, 11,  9,  7,  5,  3,  2,  1,  1,  1,  1,  1,  2,  3,  5
.db   7,  9, 11, 14, 18, 21, 25, 29, 33, 38, 43, 48, 53, 58, 64, 70, 76, 82, 88, 95,101,108,114,121,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveA:
.db 128,135,142,149,156,162,169,176,182,188,195,200,206,212,217,222,226,230,234,238,241,244,247,249,251,252,254,254,254,254,254,253,252,250,248,246,243,240,236,232,228,224,219,214,209,203,198,192
.db 185,179,172,166,159,152,145,138,131,124,117,110,103, 96, 89, 83, 76, 70, 63, 57, 52, 46, 41, 36, 31, 27, 23, 19, 15, 12,  9,  7,  5,  3,  2,  1,  1,  1,  1,  1,  3,  4,  6,  8, 11, 14, 17, 21
.db  25, 29, 33, 38, 43, 49, 55, 60, 67, 73, 79, 86, 93, 99,106,113,120,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveAIS:
.db 128,135,142,150,157,164,171,178,185,192,198,204,210,215,221,225,230,234,238,242,245,247,250,251,253,254,254,254,254,253,252,251,249,246,243,240,236,232,228,223,218,213,207,201,195,188,182,175
.db 168,161,153,146,139,131,124,116,109,102, 94, 87, 80, 73, 67, 60, 54, 48, 42, 37, 32, 27, 23, 19, 15, 12,  9,  6,  4,  3,  2,  1,  1,  1,  1,  2,  4,  5,  8, 10, 13, 17, 21, 25, 30, 34, 40, 45
.db  51, 57, 63, 70, 77, 84, 91, 98,105,113,120,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
;==================================================================================================================================================================================================
abWaveH:
.db 128,135,143,151,159,166,174,181,188,195,202,208,214,219,225,230,234,238,242,245,248,250,252,253,254,254,254,254,253,251,249,246,243,240,236,232,227,222,217,211,205,198,192,185,177,170,163,155
.db 147,139,131,124,116,108,100, 92, 85, 78, 70, 63, 57, 50, 44, 38, 33, 28, 23, 19, 15, 12,  9,  6,  4,  2,  1,  1,  1,  1,  2,  3,  5,  7, 10, 13, 17, 21, 25, 30, 36, 41, 47, 53, 60, 67, 74, 81
.db  89, 96,104,112,120,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.db   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
